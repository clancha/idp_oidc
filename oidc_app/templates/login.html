<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>IdP Demo — Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/login.css">
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <h1 class="app-title">Autenticador</h1>
      <p class="app-sub">Inicia sesión para continuar</p>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flash-list">
          {% for category, message in messages %}
            <li class="flash flash-error">
              {{ message }}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="post" action="/login" id="formulario" class="form-shell">
      <input type="hidden" name="return_to" value="{{ return_to }}">

      <!-- PANTALLA 1 -->
      <section id="screen-credentials" class="screen screen--active">
        <div class="screen-body">
          <label for="firstname" class="label">Nombre</label>
          <input id="firstname" name="firstname" placeholder="alice" required autocomplete="username given-name" class="input">

          <label for="password" class="label">Contraseña</label>
          <input id="password" name="password" type="password" placeholder="Tu contraseña" required autocomplete="current-password" class="input">
        </div>

        <div class="screen-footer">
          <button type="button" id="btn-next" class="btn btn-primary">Continuar</button>
        </div>
      </section>

      <!-- PANTALLA 2 -->
      <section id="screen-face" class="screen">
        <div class="screen-body">
          <h2 class="section-title">Verificación facial</h2>
          <p class="section-hint">Captura tu rostro.</p>

          <!-- contenedor que alterna vídeo / preview -->
          <div class="capture-box">
            <div class="video-box" id="video-box">
              <video id="video" autoplay playsinline></video>
              <canvas id="canvas" style="display:none;"></canvas>
            </div>

            <div class="preview" id="preview">
              <img id="preview-img" alt="Captura">
            </div>
          </div>

          <div class="controls">
            <button type="button" class="btn btn-primary" id="btn-start">Encender cámara</button>
            <button type="button" class="btn btn-secondary" id="btn-capture" disabled>Capturar</button>
            <button type="button" class="btn btn-secondary" id="btn-retake" style="display:none;">Repetir</button>
          </div>

          <div class="error" id="cam-error"></div>

          <!-- Imagen capturada (Base64) -->
          <input type="hidden" id="face_b64" name="face_b64" disabled>
          <input type="hidden" id="face_mime" name="face_mime" value="image/jpeg" disbaled>
        </div>

        <div class="screen-footer screen-footer--split">
          <button type="button" id="btn-back" class="btn btn-secondary">Atrás</button>
          <div class="cta-right">
            <button class="btn btn-primary" type="submit">Entrar</button>
            <div class="aux-links">
              <a class="aux-link" href="/logout">Limpiar sesión</a>
              <a class="aux-link" href="/register">Registrar</a>
            </div>
          </div>
        </div>

      </section>

      <!-- hidden que dijiste que son necesarios -->
      <input type="hidden" id="face_raw_bgr8" name="face_raw_bgr8" disabled>
      <input type="hidden" id="face_raw_meta" name="face_raw_meta" disabled>
      <input type="hidden" id="enc_payload" name="enc_payload">
    </form>
  </div>

  <script>
    const scrCred = document.getElementById('screen-credentials');
    const scrFace = document.getElementById('screen-face');
    const btnNext = document.getElementById('btn-next');
    const btnBack = document.getElementById('btn-back');

    const videoBox = document.getElementById('video-box');
    const previewBox = document.getElementById('preview');

    btnNext?.addEventListener('click', () => {
      scrCred.classList.remove('screen--active');
      scrFace.classList.add('screen--active');
    });

    btnBack?.addEventListener('click', () => {
      scrFace.classList.remove('screen--active');
      scrCred.classList.add('screen--active');
    });

    // estos ids los usará también tu main.js,
    // pero aquí dejamos claro cómo ocultar el vídeo al capturar:
    const btnRetake = document.getElementById('btn-retake');
    const btnCapture = document.getElementById('btn-capture');

    // si tu main.js ya hace la captura, solo necesitas
    // llamar a estas líneas allí cuando haya foto:
    window.showPreview = function() {
      if (videoBox) videoBox.style.display = 'none';
      if (previewBox) previewBox.style.display = 'block';
      if (btnRetake) btnRetake.style.display = 'inline-block';
    }
    window.showVideo = function() {
      if (videoBox) videoBox.style.display = 'block';
      if (previewBox) previewBox.style.display = 'none';
    }
  </script>

  <script type="module" src="/static/js/main.js"></script>
</body>
</html>
