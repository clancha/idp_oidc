<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IdP Demo â€” Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/login.css">
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <h1 class="app-title">Authenticator</h1>
      <p class="app-sub">Sign in to continue</p>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flash-list">
          {% for category, message in messages %}
            <li class="flash flash-error">
              {{ message }}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="post" action="/login" id="formulario" class="form-shell">
      <input type="hidden" name="return_to" value="{{ return_to }}">

      <!-- SCREEN 1 -->
      <section id="screen-credentials" class="screen screen--active">
        <div class="screen-body">
          <label for="firstname" class="label">Name</label>
          <input id="firstname" name="firstname" placeholder="alice" required autocomplete="username given-name" class="input">

          <label for="password" class="label">Password</label>
          <input id="password" name="password" type="password" placeholder="Your password" required autocomplete="current-password" class="input">
        </div>

        <div class="screen-footer">
          <button type="button" id="btn-next" class="btn btn-primary">Continue</button>
        </div>
      </section>

      <!-- SCREEN 2 -->
      <section id="screen-face" class="screen">
        <div class="screen-body">
          <h2 class="section-title">Face verification</h2>
          <p class="section-hint">Capture your face.</p>

          <!-- Switcher container Image / video -->
          <div class="capture-box">
            <div class="video-box" id="video-box">
              <video id="video" autoplay playsinline></video>
              <canvas id="canvas" style="display:none;"></canvas>
            </div>

            <div class="preview" id="preview">
              <img id="preview-img" alt="Capture">
            </div>
          </div>

          <div class="controls">
            <button type="button" class="btn btn-primary" id="btn-start">Turn on camera</button>
            <button type="button" class="btn btn-secondary" id="btn-capture" disabled>Capture</button>
            <button type="button" class="btn btn-secondary" id="btn-retake" style="display:none;">Retake</button>
          </div>

          <div class="error" id="cam-error"></div>

          <!-- Captured Image (Base64) -->
          <input type="hidden" id="face_b64" name="face_b64" disabled>
          <input type="hidden" id="face_mime" name="face_mime" value="image/jpeg" disbaled>
        </div>

        <div class="screen-footer screen-footer--split">
          <button type="button" id="btn-back" class="btn btn-secondary">Back</button>
          <div class="cta-right">
            <button class="btn btn-primary" type="submit">Enter</button>
            <div class="aux-links">
              <a class="aux-link" href="/logout">Clear session</a>
              <a class="aux-link" href="/register">Register</a>
            </div>
          </div>
        </div>

      </section>

      <input type="hidden" id="face_raw_bgr8" name="face_raw_bgr8" disabled>
      <input type="hidden" id="face_raw_meta" name="face_raw_meta" disabled>
      <input type="hidden" id="enc_payload" name="enc_payload">
    </form>
  </div>

  <script>
    const scrCred = document.getElementById('screen-credentials');
    const scrFace = document.getElementById('screen-face');
    const btnNext = document.getElementById('btn-next');
    const btnBack = document.getElementById('btn-back');

    const videoBox = document.getElementById('video-box');
    const previewBox = document.getElementById('preview');

    btnNext?.addEventListener('click', () => {
      scrCred.classList.remove('screen--active');
      scrFace.classList.add('screen--active');
    });

    btnBack?.addEventListener('click', () => {
      scrFace.classList.remove('screen--active');
      scrCred.classList.add('screen--active');
    });

    // main.js uses these ids too, but we spell out how to hide the video when capturing:
    const btnRetake = document.getElementById('btn-retake');
    const btnCapture = document.getElementById('btn-capture');

    // If main.js already handles capture, just call these when there is a photo:
    window.showPreview = function() {
      if (videoBox) videoBox.style.display = 'none';
      if (previewBox) previewBox.style.display = 'block';
      if (btnRetake) btnRetake.style.display = 'inline-block';
    }
    window.showVideo = function() {
      if (videoBox) videoBox.style.display = 'block';
      if (previewBox) previewBox.style.display = 'none';
    }
  </script>

  <script type="module" src="/static/js/main.js"></script>
</body>
</html>
